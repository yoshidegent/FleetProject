<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="carOrder" class="com.realdolmen.fleet.CarOrder" />

    <on-start>
        <evaluate expression="currentUser.principal" result="flashScope.principal"
                  result-type="com.realdolmen.fleet.authentication.FleetPrincipal" />
        <evaluate expression="flashScope.principal.getUser()" result="carOrder.employee"
                  result-type="com.realdolmen.fleet.Employee" />
        <set name="carOrder.status" value="T(com.realdolmen.fleet.CarOrder.OrderStatus).valueOf('PENDING')" />
    </on-start>

    <view-state id="optionSelection" model="optionSelectionList" view="order/option-selection">
        <on-entry>
            <set name="carOrder.orderedCar" value="new com.realdolmen.fleet.PhysicalCar()" />
            <evaluate expression="carServiceImpl.findCarModel(requestParameters.id)"
                      result="carOrder.orderedCar.carModel" result-type="com.realdolmen.fleet.CarModel" />

            <set name="viewScope.carModel" value="carOrder.orderedCar.carModel" />
            <evaluate expression="new com.realdolmen.fleet.viewmodels.order.OptionSelectionListModel(carModel.availableOptions)"
                      result="viewScope.optionSelectionList"
                      result-type="com.realdolmen.fleet.viewmodels.order.OptionSelectionListModel" />
        </on-entry>

        <transition to="summary" on="submit" />

        <on-exit>
            <evaluate expression="carServiceImpl.findOptionsByIds(viewScope.optionSelectionList.selection)"
                      result="carOrder.orderedCar.selectedCarOptions" />
        </on-exit>
    </view-state>

    <view-state id="summary" model="carOrder" view="order/summary">
        <transition to="saveOrder" on="submit" />
    </view-state>

    <action-state id="saveOrder">
        <evaluate expression="orderServiceImpl.saveOrder(carOrder)" />
        <transition to="end" />
    </action-state>

    <end-state id="end" view="order/end" />
</flow>