<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="carOrder" class="com.realdolmen.fleet.CarOrder" />
    
    <decision-state id="check">
        <on-entry>
            <set name="flowScope.modelId" value="requestParameters.id" />
        </on-entry>
        <if test="flowScope.modelId == null" then="cancel" else="prepare" />
    </decision-state>

    <action-state id="prepare">
        <!-- Initialize order -->
        <!-- Retrieve the current User object by first casting the principal to a
             FleetPrincipal and calling its getUser method -->
        <evaluate expression="currentUser.principal" result="flashScope.principal"
                  result-type="com.realdolmen.fleet.authentication.FleetPrincipal" />
        <evaluate expression="flashScope.principal.getUser()" result="carOrder.employee"
                  result-type="com.realdolmen.fleet.Employee" />
        <evaluate expression="T(com.realdolmen.fleet.CarOrder.OrderStatus).valueOf('PENDING')" result="carOrder.status" />

        <evaluate expression="new com.realdolmen.fleet.PhysicalCar()" result="carOrder.orderedCar" />
        <evaluate expression="carService.findCarModel(flowScope.modelId)"
                  result="carOrder.orderedCar.carModel" result-type="com.realdolmen.fleet.CarModel" />
        <transition to="carModelCheck" />
    </action-state>

    <decision-state id="carModelCheck">
        <if test="carOrder.orderedCar == null" then="cancel" else="optionSelection" />
    </decision-state>

    <view-state id="optionSelection" model="optionSelectionList" view="order/option-selection">
        <on-entry>
            <!-- Prepare view related stuff -->
            <set name="viewScope.carModel" value="carOrder.orderedCar.carModel" />
            <evaluate expression="new com.realdolmen.fleet.viewmodels.order.OptionSelectionListModel(carModel.availableOptions)"
                      result="viewScope.optionSelectionList"
                      result-type="com.realdolmen.fleet.viewmodels.order.OptionSelectionListModel" />
        </on-entry>

        <transition to="summary" on="submit">
            <evaluate expression="carOptionServiceImpl.findOptionsByIds(viewScope.optionSelectionList.selection)"
                      result="carOrder.orderedCar.selectedCarOptions" />
        </transition>
    </view-state>

    <view-state id="summary" model="carOrder" view="order/summary">
        <transition to="saveOrder" on="submit" />
    </view-state>

    <action-state id="saveOrder">
        <evaluate expression="orderServiceImpl.saveOrder(carOrder)" />
        <transition to="end" />
    </action-state>

    <end-state id="end" view="order/end" />

    <view-state id="cancel" view="externalRedirect:/" />

    <global-transitions>
        <transition to="cancel" on="cancel" />
    </global-transitions>
</flow>