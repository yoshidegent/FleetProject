<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="carOrder" class="com.realdolmen.fleet.CarOrder" />

    <view-state id="optionSelection" model="optionSelectionList" view="order/option-selection">
        <on-entry>
            <set name="carOrder.orderedCar" value="new com.realdolmen.fleet.PhysicalCar()"/>
            <evaluate expression="carServiceImpl.findCarModel(requestParameters.id)"
                      result="carOrder.orderedCar.carModel" result-type="com.realdolmen.fleet.CarModel"/>

            <set name="viewScope.carModel" value="carOrder.orderedCar.carModel" />
            <evaluate expression="new com.realdolmen.fleet.viewmodels.order.OptionSelectionListModel(carModel.availableOptions)"
                      result="viewScope.optionSelectionList"
                      result-type="com.realdolmen.fleet.viewmodels.order.OptionSelectionListModel" />
        </on-entry>

        <transition to="summary" on="submit" />
    </view-state>

    <view-state id="summary" model="carOrder" view="order/summary">
        <transition to="saveOrder" on="submit" />
    </view-state>

    <action-state id="saveOrder">
        <evaluate expression="orderServiceImpl.saveOrder(carOrder)" />
        <transition to="end" />
    </action-state>

    <end-state id="end" view="order/end" />
</flow>